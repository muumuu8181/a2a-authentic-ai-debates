#!/bin/bash
# A2Aå®Œå…¨ãƒ‡ãƒ¢ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

echo ""
echo "============================================================"
echo "ğŸ¤– A2A Agent-to-Agent Protocol å®Œå…¨ãƒ‡ãƒ¢"
echo "============================================================"
echo ""

cd ~/a2a-demo
source .venv/bin/activate

# å¤ã„ãƒ—ãƒ­ã‚»ã‚¹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
echo "ğŸ§¹ æ—¢å­˜ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—..."
kill $(lsof -t -i:9999) 2>/dev/null || true
sleep 1

echo ""
echo "1ï¸âƒ£  A2Aã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¾ã™..."
echo "------------------------------------------------------------"
echo ""

# ã‚µãƒ¼ãƒãƒ¼ã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§èµ·å‹•ã—ã€ãƒ­ã‚°ã‚’ä¿å­˜
python3 agent_server_with_logs.py > server.log 2>&1 &
SERVER_PID=$!

# ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ã‚’å¾…ã¤
echo "â³ ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ã‚’å¾…ã£ã¦ã„ã¾ã™..."
sleep 3

# ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ãŸã‹ç¢ºèª
if curl -s http://localhost:9999/health > /dev/null; then
    echo "âœ… ã‚µãƒ¼ãƒãƒ¼ãŒæ­£å¸¸ã«èµ·å‹•ã—ã¾ã—ãŸï¼"
else
    echo "âŒ ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ"
    exit 1
fi

echo ""
echo "2ï¸âƒ£  ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™..."
echo "------------------------------------------------------------"
echo ""

# ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å®Ÿè¡Œ
python3 client_test.py

echo ""
echo "3ï¸âƒ£  ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ã¾ã™..."
echo "------------------------------------------------------------"
echo ""

cat server.log

echo ""
echo "============================================================"
echo "âœ… ãƒ‡ãƒ¢å®Œäº†ï¼"
echo "============================================================"

# ã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢
kill $SERVER_PID 2>/dev/null || true

echo ""
echo "ğŸ“ ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«: ~/a2a-demo/server.log"
echo ""